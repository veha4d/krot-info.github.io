Komento.module("komento.commenttools",function(e){var t=this;Komento.require().script("komento.commentlist","komento.common").done(function(){Komento.Controller("CommentTools",{defaults:{"{commentCounter}":".commentCounter","{sortOldest}":".sortOldest a","{sortLatest}":".sortLatest a","{sortButton}":".kmt-sorting a","{adminButton}":".adminMode a",view:{newComment:"notifications/new.comment"}}},function(t){return{init:function(){Komento.options.acl.read_comment==1&&Komento.options.konfig.enable_ajax_load_list==1&&t.loadCommentList(),Komento.options.konfig.enable_live_notification==1&&(t.hasNew=0,t.newCount=0,t.checkNewComment())},loadCommentList:function(){t.reloadComments("default")},"{sortOldest} click":function(e){t.sortButton().checkClick()&&(t.sortButton().removeClass("selected"),e.loading().addClass("selected"),t.reloadComments("oldest"))},"{sortLatest} click":function(e){t.sortButton().checkClick()&&(t.sortButton().removeClass("selected"),e.loading().addClass("selected"),t.reloadComments("latest"))},"{sortLikes} click":function(e){t.sortButton().checkClick()&&(t.sortButton().removeClass("selected"),e.loading().addClass("selected"),t.reloadComments("likes"))},"{adminButton} click":function(e){t.reloadComments("default","all")},reloadComments:function(n,r){t.kmt&&t.kmt.commentlist.cancelReply(),e(".commentList").html('<img src="'+Komento.options.spinner+'" />'+e.language("COM_KOMENTO_COMMENTS_LOADING")),Komento.ajax("site.views.komento.reloadcomments",{component:Komento.component,cid:Komento.cid,contentLink:Komento.contentLink,options:{sort:n,published:r}},{success:function(r,i,s){Komento.sort=n,Komento.loadedCount=i,Komento.totalCount=s,t.setCommentCounter(i);var o=e(r);e(".commentList").html(o).controller().init(),t.sortButton().enable().doneLoading(),e(".kmt-notification").remove()},fail:function(){e(".commentList").text(e.language("COM_KOMENTO_ERROR"))}})},checkNewComment:function(){var n=Komento.options.konfig.live_notification_interval?parseInt(Komento.options.konfig.live_notification_interval)*1e3:3e4;setTimeout(function(){Komento.ajax("site.views.komento.checknewcomment",{component:Komento.component,cid:Komento.cid,total:Komento.totalCount},{success:function(n,r){if(n==1&&r>t.newCount){e(".kmt-notification").remove();var i=t.view.newComment({count:r});i.find(".reloadComments").bind("click",function(){t.kmt.tools.reloadComments(Komento.sort)}),e("body").append(i)}t.newCount=r,t.hasNew=n},fail:function(){},complete:function(){t.kmt.tools.checkNewComment()}})},n)},addCommentCounter:function(){var e=t.commentCounter().text();t.commentCounter().text(parseInt(e)+1)},deductCommentCounter:function(e){e===undefined&&(e=1);var n=t.commentCounter().text();t.commentCounter().text(parseInt(n)-e),Komento.loadedCount-=e,Komento.totalCount-=e},setCommentCounter:function(e){e===undefined&&(e=0),t.commentCounter().text(e)}}}),t.resolve()})});