Komento.module("location",function(e){var t=this;Komento.require().library("throttle-debounce","ui/autocomplete").done(function(){Komento.Controller("Location.Form.Simple",{defaultOptions:{language:"en",initialLocation:null,"{locationInput}":".locationInput","{locationLatitude}":".locationLatitude","{locationLongitude}":".locationLongitude","{autoDetectButton}":".autoDetectButton"}},function(t){return{init:function(){t.locationInput().val(e.language("COM_KOMENTO_COMMENT_WHERE_ARE_YOU")),t.locationLongitude().val(""),t.locationLatitude().val(""),t.locationInput().one("focus",function(){t.locationInput().val("")});var n=e.uid("ext");window[n]=function(){e.___GoogleMaps.resolve()},e.___GoogleMaps||(e.___GoogleMaps=e.Deferred(),window.google===undefined||window.google.maps===undefined?Komento.require().script({prefetch:!1},"https://maps.googleapis.com/maps/api/js?sensor=true&language="+t.options.language+"&callback="+n):e.___GoogleMaps.resolve()),e.___GoogleMaps.done(function(){t._init()})},_init:function(){t.geocoder=new google.maps.Geocoder,t.hasGeolocation=navigator.geolocation!==undefined,t.hasGeolocation?t.autoDetectButton().show():t.autoDetectButton().remove(),t.locationInput().autocomplete({delay:300,minLength:0,source:t.retrieveSuggestions,select:function(e,n){t.locationInput().autocomplete("close"),t.setLocation(n.item.location)}}).prop("disabled",!1),t.locationInput().addClass("location-suggestion");var n=e.trim(t.options.initialLocation);n&&t.getLocationByAddress(n,function(e){t.setLocation(e[0])}),t.busy(!1)},busy:function(e){t.locationInput().toggleClass("loading",e)},getUserLocations:function(e){t.getLocationAutomatically(function(n){t.userLocations=t.buildDataset(n),e&&e(n)})},getLocationByAddress:function(e,n){t.geocoder.geocode({address:e},n)},getLocationByCoords:function(e,n,r){t.geocoder.geocode({location:new google.maps.LatLng(e,n)},r)},getLocationAutomatically:function(e,n){if(!navigator.geolocation)return n("ERRCODE","Browser does not support geolocation or do not have permission to retrieve location data.");navigator.geolocation.getCurrentPosition(function(n){t.getLocationByCoords(n.coords.latitude,n.coords.longitude,e)},n)},setLocation:function(e){if(!e)return;t.locationResolved=!0,t.lastResolvedLocation=e,t.locationInput().val(e.formatted_address),t.locationLatitude().val(e.geometry.location.lat()),t.locationLongitude().val(e.geometry.location.lng())},removeLocation:function(){t.locationResolved=!1,t.locationInput().val(""),t.locationLatitude().val(""),t.locationLongitude().val("")},buildDataset:function(t){var n=e.map(t,function(e){return{label:e.formatted_address,value:e.formatted_address,location:e}});return n},retrieveSuggestions:function(e,n){t.busy(!0);var r=e.term,i=function(e){n(e),t.busy(!1)};r==""?i(t.userLocations||[]):t.getLocationByAddress(r,function(e){i(t.buildDataset(e))})},suggestUserLocations:function(){t.hasGeolocation&&t.userLocations&&(t.removeLocation(),t.locationInput().autocomplete("search","")),t.busy(!1)},"{locationInput} blur":function(){setTimeout(function(){var n=e.trim(t.locationInput().val());n==""?t.removeLocation():t.locationResolved?n!=t.lastResolvedLocation.formatted_address&&t.setLocation(t.lastResolvedLocation):t.removeLocation()},250)},"{autoDetectButton} click":function(){t.busy(!0),t.hasGeolocation&&!t.userLocations?t.getUserLocations(t.suggestUserLocations):t.suggestUserLocations()},"{locationInput} keypress":function(e){e.keypress(function(e){if(e.which==13)return!1})}}}),t.resolve()})});